From 7c1a8a511d4d890f80a6a16efe837577f2718d2c Mon Sep 17 00:00:00 2001
From: Salvo Giangreco <giangrecosalvo9@gmail.com>
Date: Sat, 6 Sep 2025 18:53:47 +0200
Subject: [PATCH] Allow custom PackageBlockListPolicy

---
 .../server/pm/InstallPackageHelper.smali      | 14 ++--
 .../android/server/pm/ScanPackageUtils.smali  | 10 +--
 .../pm/install/PackageBlockListPolicy.smali   | 20 +-----
 .../server/pm/lifecycle/PmLifecycleImpl.smali | 64 ++-----------------
 4 files changed, 18 insertions(+), 90 deletions(-)

diff --git a/smali_classes2/com/android/server/pm/InstallPackageHelper.smali b/smali_classes2/com/android/server/pm/InstallPackageHelper.smali
index 187451f..f9c1c12 100644
--- a/smali_classes2/com/android/server/pm/InstallPackageHelper.smali
+++ b/smali_classes2/com/android/server/pm/InstallPackageHelper.smali
@@ -14188,11 +14188,7 @@
     const/4 v7, 0x0
 
     :try_start_14
-    sget-object v1, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sIsRduDevice:Ljava/util/concurrent/atomic/AtomicBoolean;
-
-    invoke-virtual {v1}, Ljava/util/concurrent/atomic/AtomicBoolean;->get()Z
-
-    move-result v1
+    const/4 v1, 0x1
     :try_end_14
     .catch Lcom/android/server/pm/PackageManagerException; {:try_start_14 .. :try_end_14} :catch_1
     .catchall {:try_start_14 .. :try_end_14} :catchall_2
@@ -14200,11 +14196,11 @@
     if-eqz v1, :cond_12
 
     :try_start_15
-    sget-object v1, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sLduBlocklist:Ljava/util/HashSet;
+    sget-object v1, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sBlocklist:Ljava/util/HashSet;
 
     if-nez v1, :cond_10
 
-    const-string v1, "/system/etc/ldu_blocklist.xml"
+    const-string v1, "/system/etc/unica_blocklist.xml"
 
     invoke-static {v1}, Lcom/samsung/android/server/pm/install/PmConfigParser;->parsePackages(Ljava/lang/String;)Ljava/util/List;
 
@@ -14214,10 +14210,10 @@
 
     invoke-direct {v2, v1}, Ljava/util/HashSet;-><init>(Ljava/util/Collection;)V
 
-    sput-object v2, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sLduBlocklist:Ljava/util/HashSet;
+    sput-object v2, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sBlocklist:Ljava/util/HashSet;
 
     :cond_10
-    sget-object v1, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sLduBlocklist:Ljava/util/HashSet;
+    sget-object v1, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sBlocklist:Ljava/util/HashSet;
 
     invoke-virtual {v1, v13}, Ljava/util/HashSet;->contains(Ljava/lang/Object;)Z
 
diff --git a/smali_classes2/com/android/server/pm/ScanPackageUtils.smali b/smali_classes2/com/android/server/pm/ScanPackageUtils.smali
index e57e5e8..78ca975 100644
--- a/smali_classes2/com/android/server/pm/ScanPackageUtils.smali
+++ b/smali_classes2/com/android/server/pm/ScanPackageUtils.smali
@@ -965,7 +965,7 @@
 
     iget-object v8, v2, Lcom/android/server/pm/ScanRequest;->mUser:Landroid/os/UserHandle;
 
-    sget-boolean v0, Lcom/samsung/android/rune/PMRune;->PM_LDU:Z
+    const/4 v0, 0x1
 
     const-string v13, "PackageManager"
 
@@ -975,11 +975,11 @@
 
     move-result-object v0
 
-    sget-object v9, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sLduBlocklist:Ljava/util/HashSet;
+    sget-object v9, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sBlocklist:Ljava/util/HashSet;
 
     if-nez v9, :cond_0
 
-    const-string v9, "/system/etc/ldu_blocklist.xml"
+    const-string v9, "/system/etc/unica_blocklist.xml"
 
     invoke-static {v9}, Lcom/samsung/android/server/pm/install/PmConfigParser;->parsePackages(Ljava/lang/String;)Ljava/util/List;
 
@@ -989,10 +989,10 @@
 
     invoke-direct {v10, v9}, Ljava/util/HashSet;-><init>(Ljava/util/Collection;)V
 
-    sput-object v10, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sLduBlocklist:Ljava/util/HashSet;
+    sput-object v10, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sBlocklist:Ljava/util/HashSet;
 
     :cond_0
-    sget-object v9, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sLduBlocklist:Ljava/util/HashSet;
+    sget-object v9, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sBlocklist:Ljava/util/HashSet;
 
     invoke-virtual {v9, v0}, Ljava/util/HashSet;->contains(Ljava/lang/Object;)Z
 
diff --git a/smali_classes2/com/samsung/android/server/pm/install/PackageBlockListPolicy.smali b/smali_classes2/com/samsung/android/server/pm/install/PackageBlockListPolicy.smali
index d48d8d8..2f6a98b 100644
--- a/smali_classes2/com/samsung/android/server/pm/install/PackageBlockListPolicy.smali
+++ b/smali_classes2/com/samsung/android/server/pm/install/PackageBlockListPolicy.smali
@@ -4,22 +4,4 @@
 
 
 # static fields
-.field public static final sIsRduDevice:Ljava/util/concurrent/atomic/AtomicBoolean;
-
-.field public static sLduBlocklist:Ljava/util/HashSet;
-
-
-# direct methods
-.method static constructor <clinit>()V
-    .locals 2
-
-    new-instance v0, Ljava/util/concurrent/atomic/AtomicBoolean;
-
-    const/4 v1, 0x0
-
-    invoke-direct {v0, v1}, Ljava/util/concurrent/atomic/AtomicBoolean;-><init>(Z)V
-
-    sput-object v0, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sIsRduDevice:Ljava/util/concurrent/atomic/AtomicBoolean;
-
-    return-void
-.end method
+.field public static sBlocklist:Ljava/util/HashSet;
diff --git a/smali_classes2/com/samsung/android/server/pm/lifecycle/PmLifecycleImpl.smali b/smali_classes2/com/samsung/android/server/pm/lifecycle/PmLifecycleImpl.smali
index b4ed428..6adeb01 100644
--- a/smali_classes2/com/samsung/android/server/pm/lifecycle/PmLifecycleImpl.smali
+++ b/smali_classes2/com/samsung/android/server/pm/lifecycle/PmLifecycleImpl.smali
@@ -2088,56 +2088,6 @@
     invoke-virtual {v0, v2}, Landroid/app/job/JobScheduler;->schedule(Landroid/app/job/JobInfo;)I
 
     :goto_14
-    iget-object v0, v1, Lcom/samsung/android/server/pm/lifecycle/PmLifecycleImpl;->mInjector:Lcom/android/server/pm/PackageManagerServiceInjector;
-
-    iget-object v2, v0, Lcom/android/server/pm/PackageManagerServiceInjector;->mContext:Landroid/content/Context;
-
-    invoke-virtual {v0}, Lcom/android/server/pm/PackageManagerServiceInjector;->getHandler()Landroid/os/Handler;
-
-    move-result-object v0
-
-    sget-object v3, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sLduBlocklist:Ljava/util/HashSet;
-
-    invoke-virtual {v2}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
-
-    move-result-object v2
-
-    sget-object v3, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy;->sIsRduDevice:Ljava/util/concurrent/atomic/AtomicBoolean;
-
-    const-string/jumbo v4, "shopdemo"
-
-    const/4 v5, 0x0
-
-    invoke-static {v2, v4, v5}, Landroid/provider/Settings$Secure;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I
-
-    move-result v6
-
-    const/4 v7, 0x1
-
-    if-ne v6, v7, :cond_18
-
-    move v6, v7
-
-    goto :goto_15
-
-    :cond_18
-    move v6, v5
-
-    :goto_15
-    invoke-virtual {v3, v6}, Ljava/util/concurrent/atomic/AtomicBoolean;->set(Z)V
-
-    invoke-static {v4}, Landroid/provider/Settings$Secure;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
-
-    move-result-object v3
-
-    new-instance v4, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy$1;
-
-    invoke-direct {v4, v0, v2}, Lcom/samsung/android/server/pm/install/PackageBlockListPolicy$1;-><init>(Landroid/os/Handler;Landroid/content/ContentResolver;)V
-
-    const/4 v6, -0x1
-
-    invoke-virtual {v2, v3, v5, v4, v6}, Landroid/content/ContentResolver;->registerContentObserver(Landroid/net/Uri;ZLandroid/database/ContentObserver;I)V
-
     iget-object v0, v1, Lcom/samsung/android/server/pm/lifecycle/PmLifecycleImpl;->mATCommandReceiver:Lcom/samsung/android/server/pm/mm/MaintenanceModeManager$ATCommandReceiver;
 
     iget-object v2, v1, Lcom/samsung/android/server/pm/lifecycle/PmLifecycleImpl;->mInjector:Lcom/android/server/pm/PackageManagerServiceInjector;
@@ -2196,27 +2146,27 @@
     :try_end_b
     .catch Ljava/lang/Exception; {:try_start_b .. :try_end_b} :catch_4
 
-    if-eqz v5, :cond_19
+    if-eqz v5, :cond_18
 
-    if-eqz v0, :cond_19
+    if-eqz v0, :cond_18
 
     move v2, v7
 
-    goto :goto_16
+    goto :goto_15
 
-    :cond_19
+    :cond_18
     move v2, v4
 
-    :goto_16
+    :goto_15
     move v4, v2
 
-    goto :goto_17
+    goto :goto_16
 
     :catch_3
     const/4 v4, 0x0
 
     :catch_4
-    :goto_17
+    :goto_16
     iput-boolean v4, v1, Lcom/samsung/android/server/pm/lifecycle/PmLifecycleImpl;->mIsUserTrial:Z
 
     return-void
-- 
2.51.0

